<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Sistema de Fichaje y NÃ³minas</title>
Â  Â  <!-- Carga de Tailwind CSS -->
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  /* Estilos personalizados para la tipografÃ­a */
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #f7f7f7;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Estilos para que el contenido se centre y se vea bien en mÃ³vil */
Â  Â  Â  Â  .container-wrapper {
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card {
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-primary {
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-primary:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-1px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

<div class="container-wrapper">
Â  Â  <!-- TÃ­tulo y Estado de la AplicaciÃ³n -->
Â  Â  <header class="text-center py-6">
Â  Â  Â  Â  <h1 class="text-3xl font-bold text-gray-800">Sistema de Control de Horas</h1>
Â  Â  Â  Â  <p id="auth-status" class="mt-2 text-sm font-medium text-blue-600">Conectando a la base de datos...</p>
Â  Â  </header>

Â  Â  <!-- PestaÃ±as de NavegaciÃ³n -->
Â  Â  <div class="flex mb-6 space-x-2 p-1 bg-white rounded-xl card">
Â  Â  Â  Â  <button id="tab-waiter" onclick="showSection('waiter')" class="flex-1 py-2 text-sm font-semibold rounded-lg transition-colors bg-blue-500 text-white">
Â  Â  Â  Â  Â  Â  Registro de Horas
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button id="tab-admin" onclick="showSection('admin')" class="flex-1 py-2 text-sm font-semibold rounded-lg transition-colors text-gray-600 hover:bg-gray-100">
Â  Â  Â  Â  Â  Â  Panel de AdministraciÃ³n
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <!-- SECCIÃ“N DE REGISTRO DE CAMAREROS -->
Â  Â  <div id="section-waiter" class="tab-content">
Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl card mb-6">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-gray-700 mb-4">Registro Manual de Jornada</h2>
Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mb-4">Ingresa tu hora de entrada y salida, nombre y telÃ©fono al finalizar tu turno.</p>

Â  Â  Â  Â  Â  Â  <form id="waiter-form" onsubmit="handleWaiterForm(event)">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Nombre Completo -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="name" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="name" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- NÃºmero de TelÃ©fono (para identificarte) -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="phone" class="block text-sm font-medium text-gray-700">TelÃ©fono (WhatsApp)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="phone" name="phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: +34600123456">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Hora de Entrada Manual -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="entryTime" class="block text-sm font-medium text-gray-700">Hora de ENTRADA (Manual)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="entryTime" name="entryTime" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Hora de Salida Manual -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="exitTime" class="block text-sm font-medium text-gray-700">Hora de SALIDA (Actual)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="exitTime" name="exitTime" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- OpciÃ³n de Coche -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center h-5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="usedCar" name="usedCar" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ml-3 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="usedCar" class="font-medium text-gray-700">UsÃ© mi coche para el trabajo</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500">Se aÃ±adirÃ¡ la compensaciÃ³n establecida por el administrador.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- BotÃ³n de Registro -->
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="submit-btn" class="mt-6 w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-lg font-semibold text-white bg-blue-600 btn-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Registrar Jornada
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  <p id="waiter-message" class="mt-4 text-center text-sm font-medium hidden"></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â <p class="text-xs text-gray-400 text-center mt-8">Tu ID de SesiÃ³n: <span id="user-id">Cargando...</span></p>
Â  Â  </div>

Â  Â  <!-- SECCIÃ“N DE ADMINISTRACIÃ“N -->
Â  Â  <div id="section-admin" class="tab-content hidden">
Â  Â  Â  Â  <!-- Bloque de Login Admin (Demo) -->
Â  Â  Â  Â  <div id="admin-login-block" class="bg-white p-6 rounded-xl card mb-6">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-gray-700 mb-4">Acceso a AdministraciÃ³n</h2>
Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mb-4">Ingresa el PIN de administrador para acceder a las nÃ³minas y ajustes.</p>
Â  Â  Â  Â  Â  Â  <input type="password" id="admin-pin" placeholder="PIN (Ej: 1234)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
Â  Â  Â  Â  Â  Â  <button onclick="checkAdminPin()" class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
Â  Â  Â  Â  Â  Â  Â  Â  Entrar
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <p id="admin-error" class="mt-2 text-sm font-medium text-red-500 hidden">PIN Incorrecto.</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Panel de AdministraciÃ³n (Oculto hasta el login) -->
Â  Â  Â  Â  <div id="admin-panel" class="hidden">
Â  Â  Â  Â  Â  Â  <!-- ConfiguraciÃ³n de Ajustes -->
Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl card mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-gray-700 mb-4">Ajustes de NÃ³mina Diaria</h3>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  <!-- CompensaciÃ³n por Coche -->
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="carAllowance" class="block text-sm font-medium text-gray-700">CompensaciÃ³n por Coche (Hoy)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-1 flex rounded-md shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">â‚¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="carAllowance" value="5.00" step="0.01" min="0" class="flex-1 block w-full rounded-none rounded-r-md px-3 py-2 border border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mt-1">Valor actual: <span id="currentAllowance">5.00</span>â‚¬</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- Toggle de Multiples Registros -->
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between mb-4 p-3 bg-gray-50 rounded-md border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="multiShiftToggle" class="text-sm font-medium text-gray-700 cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Permitir MÃºltiples Registros por dÃ­a
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="multiShiftToggle" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="saveSettings()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Guardar Ajustes
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Listado de NÃ³minas por AÃ±o/Mes -->
Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl card mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-gray-700 mb-4">NÃ³minas y ResÃºmenes</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mb-4">El salario base es de **9â‚¬/hora**.</p>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="payroll-loading" class="text-center py-4 text-gray-500">Cargando datos de nÃ³minas...</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="payroll-list" class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Contenido de NÃ³minas Generado por JS -->
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Listado de Registros Crudos -->
Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl card">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-gray-700 mb-4">Registros Crudos (Listado)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mb-2">AquÃ­ puedes ver todos los registros manuales.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-h-80 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul id="raw-records-list" class="text-sm space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Registros Crudos Generados por JS -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<!-- Scripts de Firebase y LÃ³gica de la AplicaciÃ³n -->
<script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

Â  Â  // Establecer nivel de log para depuraciÃ³n de Firestore
Â  Â  setLogLevel('error');

Â  Â  // --- VARIABLES GLOBALES (PROPORCIONADAS POR EL ENTORNO) ---
Â  Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â  Â  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
Â  Â  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

Â  Â  // --- CONFIGURACIÃ“N FIREBASE ---
Â  Â  let app, auth, db;
Â  Â  let userId = null;
Â  Â  let records = [];
Â  Â  let settings = {
Â  Â  Â  Â  carAllowance: 5.00, // â‚¬ por defecto
Â  Â  Â  Â  enableMultiShift: false
Â  Â  };

Â  Â  // Colecciones
Â  Â  const RECORDS_PATH = `artifacts/${appId}/public/data/waiter_records`;
Â  Â  const SETTINGS_DOC_PATH = `artifacts/${appId}/public/data/app_settings/config`;

Â  Â  // ParÃ¡metros de nÃ³mina
Â  Â  const HOURLY_RATE = 9.00; // â‚¬/hora

Â  Â  // ConfiguraciÃ³n del Admin
Â  Â  // Se usa __ADMIN_PIN inyectado para la contraseÃ±a, con un fallback simple por si acaso.
Â  Â  const ADMIN_PIN = typeof __ADMIN_PIN !== 'undefined' ? __ADMIN_PIN : '1234'; 
Â  Â  let adminLoggedIn = false;


Â  Â  // --- FUNCIONES CORE ---

Â  Â  // 1. InicializaciÃ³n y AutenticaciÃ³n
Â  Â  const initializeAppAndAuth = async () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  auth = getAuth(app);
Â  Â  Â  Â  Â  Â  db = getFirestore(app);

Â  Â  Â  Â  Â  Â  // Usar persistencia de sesiÃ³n
Â  Â  Â  Â  Â  Â  await setPersistence(auth, browserSessionPersistence);

Â  Â  Â  Â  Â  Â  if (initialAuthToken) {
Â  Â  Â  Â  Â  Â  Â  Â  await signInWithCustomToken(auth, initialAuthToken);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Listener de estado de autenticaciÃ³n
Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId = user.uid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('user-id').textContent = userId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('auth-status').textContent = 'Conectado. ID: ' + userId.substring(0, 8) + '...';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Solo cargamos datos si el usuario estÃ¡ autenticado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startDataListeners();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('auth-status').textContent = 'Desconectado.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si falla, intentamos anÃ³nimo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signInAnonymously(auth).catch(e => console.error("Fallo al iniciar sesiÃ³n anÃ³nima:", e));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Error al inicializar Firebase:", e);
Â  Â  Â  Â  Â  Â  document.getElementById('auth-status').textContent = 'Error de conexiÃ³n.';
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // 2. Listeners de Datos (Firestore)
Â  Â  const startDataListeners = () => {
Â  Â  Â  Â  // Listener de Ajustes (Settings)
Â  Â  Â  Â  const settingsRef = doc(db, SETTINGS_DOC_PATH);
Â  Â  Â  Â  onSnapshot(settingsRef, (docSnap) => {
Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  settings = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Ajustes cargados:", settings);
Â  Â  Â  Â  Â  Â  Â  Â  updateSettingsUI();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("No hay ajustes. Creando por defecto...");
Â  Â  Â  Â  Â  Â  Â  Â  saveSettings(true); // Crear configuraciÃ³n por defecto si no existe
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  console.error("Error al escuchar ajustes:", error);
Â  Â  Â  Â  });

Â  Â  Â  Â  // Listener de Registros (Records)
Â  Â  Â  Â  const recordsColRef = collection(db, RECORDS_PATH);
Â  Â  Â  Â  onSnapshot(recordsColRef, (snapshot) => {
Â  Â  Â  Â  Â  Â  records = [];
Â  Â  Â  Â  Â  Â  snapshot.forEach((doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  records.push({ id: doc.id, ...data });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  console.log("Registros cargados:", records);
Â  Â  Â  Â  Â  Â  // Actualizar la vista de registros y nÃ³minas solo si es admin
Â  Â  Â  Â  Â  Â  if (adminLoggedIn) {
Â  Â  Â  Â  Â  Â  Â  Â  renderRawRecords();
Â  Â  Â  Â  Â  Â  Â  Â  renderPayroll();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  console.error("Error al escuchar registros:", error);
Â  Â  Â  Â  });
Â  Â  };

Â  Â  // 3. Guardar Ajustes
Â  Â  window.saveSettings = async (isDefault = false) => {
Â  Â  Â  Â  if (!userId) {
Â  Â  Â  Â  Â  Â  alertMessage("Error: SesiÃ³n no iniciada.", "waiter-message", "text-red-500");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const newCarAllowance = parseFloat(document.getElementById('carAllowance').value);
Â  Â  Â  Â  const newMultiShiftToggle = document.getElementById('multiShiftToggle').checked;

Â  Â  Â  Â  settings.carAllowance = newCarAllowance;
Â  Â  Â  Â  settings.enableMultiShift = newMultiShiftToggle;

Â  Â  Â  Â  const settingsData = {
Â  Â  Â  Â  Â  Â  carAllowance: settings.carAllowance,
Â  Â  Â  Â  Â  Â  enableMultiShift: settings.enableMultiShift,
Â  Â  Â  Â  Â  Â  lastUpdatedBy: userId,
Â  Â  Â  Â  Â  Â  timestamp: new Date().toISOString()
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const settingsRef = doc(db, SETTINGS_DOC_PATH);
Â  Â  Â  Â  Â  Â  await setDoc(settingsRef, settingsData);
Â  Â  Â  Â  Â  Â  alertMessage(`Ajustes guardados con Ã©xito. ${isDefault ? '(Por defecto)' : ''}`, "admin-panel", "text-green-600");
Â  Â  Â  Â  Â  Â  updateSettingsUI();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Error al guardar ajustes: ", e);
Â  Â  Â  Â  Â  Â  alertMessage("Error al guardar ajustes.", "admin-panel", "text-red-500");
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // 4. Actualizar UI de Ajustes
Â  Â  const updateSettingsUI = () => {
Â  Â  Â  Â  if (settings) {
Â  Â  Â  Â  Â  Â  document.getElementById('carAllowance').value = settings.carAllowance.toFixed(2);
Â  Â  Â  Â  Â  Â  document.getElementById('currentAllowance').textContent = settings.carAllowance.toFixed(2);
Â  Â  Â  Â  Â  Â  document.getElementById('multiShiftToggle').checked = settings.enableMultiShift;
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // 5. Manejar el Formulario del Camarero
Â  Â  window.handleWaiterForm = async (event) => {
Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â 
Â  Â  Â  Â  if (!userId) {
Â  Â  Â  Â  Â  Â  alertMessage("Error: SesiÃ³n no iniciada. Espera la conexiÃ³n.", "waiter-message", "text-red-500");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const form = event.target;
Â  Â  Â  Â  const name = form.name.value.trim();
Â  Â  Â  Â  const phone = form.phone.value.trim();
Â  Â  Â  Â  const entryTimeStr = form.entryTime.value;
Â  Â  Â  Â  const exitTimeStr = form.exitTime.value;
Â  Â  Â  Â  const usedCar = form.usedCar.checked;
Â  Â  Â  Â 
Â  Â  Â  Â  const today = new Date().toISOString().slice(0, 0, 10); // YYYY-MM-DD

Â  Â  Â  Â  // 5.1. ValidaciÃ³n de Registro Ãšnico (si no estÃ¡ permitido el multi-shift)
Â  Â  Â  Â  if (!settings.enableMultiShift) {
Â  Â  Â  Â  Â  Â  const alreadyRegistered = records.some(
Â  Â  Â  Â  Â  Â  Â  Â  record => record.phone === phone && record.date === today
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  if (alreadyRegistered) {
Â  Â  Â  Â  Â  Â  Â  Â  alertMessage("Ya existe un registro para tu telÃ©fono hoy. No se permite multi-shift.", "waiter-message", "text-red-500");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // 5.2. CÃ¡lculo de DuraciÃ³n y Salario
Â  Â  Â  Â  const entry = new Date(today + 'T' + entryTimeStr + ':00');
Â  Â  Â  Â  const exit = new Date(today + 'T' + exitTimeStr + ':00');
Â  Â  Â  Â 
Â  Â  Â  Â  // Si la salida es anterior a la entrada, asumimos que fue al dÃ­a siguiente (turno nocturno)
Â  Â  Â  Â  if (exit < entry) {
Â  Â  Â  Â  Â  Â  exit.setDate(exit.getDate() + 1);
Â  Â  Â  Â  }

Â  Â  Â  Â  const durationMs = exit - entry;
Â  Â  Â  Â  const durationHours = durationMs / (1000 * 60 * 60);

Â  Â  Â  Â  if (durationHours <= 0) {
Â  Â  Â  Â  Â  Â  alertMessage("La hora de salida debe ser posterior a la de entrada.", "waiter-message", "text-red-500");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â 
Â  Â  Â  Â  const basePay = durationHours * HOURLY_RATE;
Â  Â  Â  Â  const carAllowance = usedCar ? settings.carAllowance : 0;
Â  Â  Â  Â  const totalPay = basePay + carAllowance;
Â  Â  Â  Â 
Â  Â  Â  Â  const recordData = {
Â  Â  Â  Â  Â  Â  name,
Â  Â  Â  Â  Â  Â  phone,
Â  Â  Â  Â  Â  Â  entryTime: entryTimeStr,
Â  Â  Â  Â  Â  Â  exitTime: exitTimeStr,
Â  Â  Â  Â  Â  Â  date: today,
Â  Â  Â  Â  Â  Â  yearMonth: today.substring(0, 7), // YYYY-MM
Â  Â  Â  Â  Â  Â  durationHours: parseFloat(durationHours.toFixed(2)),
Â  Â  Â  Â  Â  Â  ratePerHour: HOURLY_RATE,
Â  Â  Â  Â  Â  Â  carAllowance: carAllowance,
Â  Â  Â  Â  Â  Â  totalPay: parseFloat(totalPay.toFixed(2)),
Â  Â  Â  Â  Â  Â  usedCar: usedCar,
Â  Â  Â  Â  Â  Â  registeredAt: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  userId: userId // ID del usuario que registrÃ³ (en este caso, el camarero)
Â  Â  Â  Â  };

Â  Â  Â  Â  // 5.3. Guardar en Firestore
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const recordsColRef = collection(db, RECORDS_PATH);
Â  Â  Â  Â  Â  Â  await addDoc(recordsColRef, recordData);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // 5.4. SimulaciÃ³n de NotificaciÃ³n Twilio
Â  Â  Â  Â  Â  Â  sendWhatsAppNotification(recordData);

Â  Â  Â  Â  Â  Â  alertMessage(`Jornada registrada con Ã©xito. Cobro estimado: ${totalPay.toFixed(2)}â‚¬ (${durationHours.toFixed(2)}h @${HOURLY_RATE}â‚¬).`, "waiter-message", "text-green-600");
Â  Â  Â  Â  Â  Â  form.reset(); // Limpiar el formulario

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Error al guardar el registro: ", e);
Â  Â  Â  Â  Â  Â  alertMessage("Error al guardar en la base de datos.", "waiter-message", "text-red-500");
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // 6. SimulaciÃ³n de NotificaciÃ³n Twilio (WhatsApp)
Â  Â  const sendWhatsAppNotification = (data) => {
Â  Â  Â  Â  const message = `
ðŸš¨ NUEVO REGISTRO DE JORNADA ðŸš¨
---------------------------------
ðŸ‘¤ Camarero: ${data.name}
ðŸ“ž TelÃ©fono: ${data.phone}
ðŸ“… Fecha: ${data.date}
â° Entrada: ${data.entryTime}
ðŸšª Salida: ${data.exitTime}
â³ Horas Totales: ${data.durationHours.toFixed(2)}h
ðŸš— UsÃ³ Coche: ${data.usedCar ? 'SÃ' : 'NO'} (${data.carAllowance.toFixed(2)}â‚¬)
ðŸ’° Pago Total: ${data.totalPay.toFixed(2)}â‚¬

ðŸ‘‰ *AquÃ­ es donde deberÃ­as integrar tu lÃ³gica real de Twilio (usando fetch o un servidor backend) para enviar este mensaje a tu nÃºmero de WhatsApp.*
Â  Â  Â  Â  `;
Â  Â  Â  Â  console.log(message);
Â  Â  Â  Â  // Opcional: mostrar un mensaje en el UI de que la notificaciÃ³n se ha simulado.
Â  Â  };
Â  Â 
Â  Â  // 7. Renderizar Registros Crudos (Admin)
Â  Â  const renderRawRecords = () => {
Â  Â  Â  Â  const listEl = document.getElementById('raw-records-list');
Â  Â  Â  Â  listEl.innerHTML = '';
Â  Â  Â  Â  if (records.length === 0) {
Â  Â  Â  Â  Â  Â  listEl.innerHTML = '<li class="text-gray-500">No hay registros aÃºn.</li>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Ordenar por fecha descendente
Â  Â  Â  Â  const sortedRecords = [...records].sort((a, b) => new Date(b.registeredAt) - new Date(a.registeredAt));

Â  Â  Â  Â  sortedRecords.forEach(record => {
Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  li.className = 'p-2 border-b border-gray-100 flex justify-between';
Â  Â  Â  Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-semibold text-gray-800">${record.name}</span> (${record.phone})
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs text-gray-500 block">${record.date} ${record.entryTime} - ${record.exitTime} (${record.durationHours}h)</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-blue-600">${record.totalPay.toFixed(2)}â‚¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${record.usedCar ? '<span class="text-xs text-green-500 block">ðŸš— Coche</span>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  listEl.appendChild(li);
Â  Â  Â  Â  });
Â  Â  };

Â  Â  // 8. Calcular y Renderizar NÃ³minas Agrupadas (Admin)
Â  Â  const renderPayroll = () => {
Â  Â  Â  Â  document.getElementById('payroll-loading').classList.add('hidden');
Â  Â  Â  Â  const payrollListEl = document.getElementById('payroll-list');
Â  Â  Â  Â  payrollListEl.innerHTML = '';
Â  Â  Â  Â 
Â  Â  Â  Â  if (records.length === 0) {
Â  Â  Â  Â  Â  Â  payrollListEl.innerHTML = '<p class="text-gray-500">No hay datos suficientes para generar nÃ³minas.</p>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Estructura: { YYYY: { MM: { Camarero: { totalHours, totalPay, totalCarAllowance } } } }
Â  Â  Â  Â  const payrollData = {};

Â  Â  Â  Â  records.forEach(record => {
Â  Â  Â  Â  Â  Â  const year = record.yearMonth.substring(0, 4);
Â  Â  Â  Â  Â  Â  const month = record.yearMonth.substring(5, 7);
Â  Â  Â  Â  Â  Â  const waiterKey = record.name + ' (' + record.phone + ')';

Â  Â  Â  Â  Â  Â  if (!payrollData[year]) payrollData[year] = {};
Â  Â  Â  Â  Â  Â  if (!payrollData[year][month]) payrollData[year][month] = {};
Â  Â  Â  Â  Â  Â  if (!payrollData[year][month][waiterKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  payrollData[year][month][waiterKey] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalHours: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalPay: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalCarAllowance: 0
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  payrollData[year][month][waiterKey].totalHours += record.durationHours;
Â  Â  Â  Â  Â  Â  payrollData[year][month][waiterKey].totalPay += record.totalPay;
Â  Â  Â  Â  Â  Â  payrollData[year][month][waiterKey].totalCarAllowance += record.carAllowance;
Â  Â  Â  Â  });

Â  Â  Â  Â  // Renderizado
Â  Â  Â  Â  const monthNames = { '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril', '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto', '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre' };
Â  Â  Â  Â 
Â  Â  Â  Â  // Ordenar AÃ±os de forma descendente
Â  Â  Â  Â  Object.keys(payrollData).sort((a, b) => b - a).forEach(year => {
Â  Â  Â  Â  Â  Â  const yearBlock = document.createElement('div');
Â  Â  Â  Â  Â  Â  yearBlock.className = 'border-4 border-blue-100 rounded-xl p-4 bg-blue-50';
Â  Â  Â  Â  Â  Â  yearBlock.innerHTML = `<h4 class="text-xl font-bold text-blue-800 mb-4">AÃ±o ${year}</h4><div class="space-y-4" id="year-${year}"></div>`;
Â  Â  Â  Â  Â  Â  payrollListEl.appendChild(yearBlock);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // Ordenar Meses de forma descendente
Â  Â  Â  Â  Â  Â  Object.keys(payrollData[year]).sort((a, b) => b - a).forEach(month => {
Â  Â  Â  Â  Â  Â  Â  Â  const monthBlock = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  monthBlock.className = 'border border-gray-200 rounded-lg p-3 bg-white shadow-sm';
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  let monthHTML = `<h5 class="text-lg font-semibold text-gray-700 mb-3">${monthNames[month] || month}</h5><ul class="space-y-2">`;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Renderizar Camareros
Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(payrollData[year][month]).forEach(waiter => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = payrollData[year][month][waiter];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  monthHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="border-b border-dashed pb-2 last:border-b-0 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-gray-800">${waiter}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between text-gray-600 mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Total Horas:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">${data.totalHours.toFixed(2)} h</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between text-gray-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>CompensaciÃ³n Coche:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-green-600">${data.totalCarAllowance.toFixed(2)} â‚¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between text-gray-800 mt-1 pt-1 border-t border-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-extrabold">TOTAL A PAGAR:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-extrabold text-2xl text-red-600">${data.totalPay.toFixed(2)} â‚¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  monthHTML += '</ul>';
Â  Â  Â  Â  Â  Â  Â  Â  monthBlock.innerHTML = monthHTML;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`year-${year}`).appendChild(monthBlock);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  };

Â  Â  // 9. Funciones de UI
Â  Â  window.showSection = (sectionId) => {
Â  Â  Â  Â  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
Â  Â  Â  Â  document.querySelectorAll('.flex > button').forEach(el => {
Â  Â  Â  Â  Â  Â  el.classList.remove('bg-blue-500', 'text-white');
Â  Â  Â  Â  Â  Â  el.classList.add('text-gray-600', 'hover:bg-gray-100');
Â  Â  Â  Â  });

Â  Â  Â  Â  document.getElementById(`section-${sectionId}`).classList.remove('hidden');
Â  Â  Â  Â  document.getElementById(`tab-${sectionId}`).classList.remove('text-gray-600', 'hover:bg-gray-100');
Â  Â  Â  Â  document.getElementById(`tab-${sectionId}`).classList.add('bg-blue-500', 'text-white');
Â  Â  };

Â  Â  window.checkAdminPin = () => {
Â  Â  Â  Â  const pin = document.getElementById('admin-pin').value;
Â  Â  Â  Â  const errorEl = document.getElementById('admin-error');
Â  Â  Â  Â  if (pin === ADMIN_PIN) {
Â  Â  Â  Â  Â  Â  adminLoggedIn = true;
Â  Â  Â  Â  Â  Â  errorEl.classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('admin-login-block').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('admin-panel').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  // Cargar datos una vez que el admin ha iniciado sesiÃ³n
Â  Â  Â  Â  Â  Â  renderRawRecords();
Â  Â  Â  Â  Â  Â  renderPayroll();
Â  Â  Â  Â  Â  Â  alertMessage("Acceso de Admin concedido.", "admin-panel", "text-green-600");
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  errorEl.classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  };
Â  Â 
Â  Â  // FunciÃ³n de ayuda para mostrar mensajes temporales
Â  Â  const alertMessage = (message, elementId, colorClass) => {
Â  Â  Â  Â  let el;
Â  Â  Â  Â  if (elementId === 'admin-panel') {
Â  Â  Â  Â  Â  Â  // Buscamos un mensaje general en el panel admin
Â  Â  Â  Â  Â  Â  const adminPanel = document.getElementById('admin-panel');
Â  Â  Â  Â  Â  Â  el = adminPanel.querySelector('p.temp-msg');
Â  Â  Â  Â  Â  Â  if (!el) {
Â  Â  Â  Â  Â  Â  Â  Â  el = document.createElement('p');
Â  Â  Â  Â  Â  Â  Â  Â  el.className = 'mt-2 text-center text-sm font-medium temp-msg';
Â  Â  Â  Â  Â  Â  Â  Â  adminPanel.prepend(el);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  el = document.getElementById(elementId);
Â  Â  Â  Â  }
Â  Â  Â  Â 
Â  Â  Â  Â  // Limpiar clases de color previas y aplicar las nuevas
Â  Â  Â  Â  el.className = el.className.split(' ').filter(c => !c.startsWith('text-')).join(' ');
Â  Â  Â  Â  el.textContent = message;
Â  Â  Â  Â  el.className += ` mt-4 text-center text-sm font-medium ${colorClass}`;
Â  Â  Â  Â  el.classList.remove('hidden');
Â  Â  Â  Â 
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  el.classList.add('hidden');
Â  Â  Â  Â  }, 5000);
Â  Â  };

Â  Â  // --- INICIO DE LA APLICACIÃ“N ---
Â  Â  window.onload = initializeAppAndAuth;

</script>
</body>
</html>